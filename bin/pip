#!osascript
set jsStartPip to "document.querySelector('video').webkitSetPresentationMode('picture-in-picture')"

set jsVideoExistsAndInline to "if (document.querySelector('video')!== null) document.querySelector('video').webkitPresentationMode === 'inline' ? true : false; else false;"

on closePip()
	tell application "System Events"
		if exists (window 1 of process "PIPAgent") then
			-- display dialog "Found window 1"
			-- get every UI element of (window 1 of process "PIPAgent")
			click button 3 of (window 1 of process "PIPAgent")
			-- click button 1 of (window 1 of process "PIPAgent")
		end if
	end tell
end closePip

-- tell application "Safari" to activate
-- tell application "IINA" to activate


tell application "System Events" to set frontApp to name of first process whose frontmost is true

if frontApp = "Safari" then
	tell application "Safari"
		set isVideoInline to do JavaScript jsVideoExistsAndInline in front document
		if isVideoInline then
			do JavaScript jsStartPip in front document
		else
			tell application "System Events"
				if exists (window 1 of process "PIPAgent") then
					-- display dialog "Found window 1"
					-- get every UI element of (window 1 of process "PIPAgent")
					click button 3 of (window 1 of process "PIPAgent")
					-- click button 1 of (window 1 of process "PIPAgent")
				end if
			end tell
		end if
	end tell
else if (frontApp = "IINA") then
	tell application "System Events"
		tell process "IINA"
			try
				click menu item "Enter Picture-in-Picture" of menu "Video" of menu bar 1
			on error
				click menu item "Exit Picture-in-Picture" of menu "Video" of menu bar 1
			end try
		end tell
	end tell
else
	closePip()
end if
